{"componentChunkName":"component---src-templates-blog-post-blog-post-tsx","path":"/post/2020-10/defocus-blur/","result":{"data":{"markdownRemark":{"html":"<p>The last feature implemented in the source material is defocus blur, or depth of field.\nThis is an effect seen in cameras due to the way the aperture, lens, and light sensor interact.\nThe result is that the scene is partially out of focus.</p>\n<h3 id=\"a-thin-lens-approximation\" style=\"position:relative;\"><a href=\"#a-thin-lens-approximation\" aria-label=\"a thin lens approximation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>A Thin Lens Approximation</h3>\n<p>In our case we will use a simple approximation, simulating only the lens.</p>\n<h3 id=\"generating-sample-rays\" style=\"position:relative;\"><a href=\"#generating-sample-rays\" aria-label=\"generating sample rays permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Generating Sample Rays</h3>\n<p>First we need to generate rays in a disk, the disk being ab approximation of the lens:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre style=\"counter-reset: linenumber 0\" class=\"language-rust line-numbers\"><code class=\"language-rust\">    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">random_in_unit_disk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Vec3</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">loop</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> p <span class=\"token operator\">=</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token function\">random_in_range</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token function\">random_in_range</span><span class=\"token punctuation\">(</span><span class=\"token operator\">-</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token keyword\">if</span> p<span class=\"token punctuation\">.</span><span class=\"token function\">length_squared</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">1.0</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> p<span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Now update our camera to generate arrays at a random location inside of the disk:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre style=\"counter-reset: linenumber 0\" class=\"language-rust line-numbers\"><code class=\"language-rust\"><span class=\"token keyword\">pub</span> <span class=\"token keyword\">struct</span> <span class=\"token type-definition class-name\">Camera</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">pub</span> origin<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Point3</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">pub</span> lower_left_corner<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Point3</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">pub</span> horizontal<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">pub</span> vertical<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">pub</span> lens_radius<span class=\"token punctuation\">:</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">pub</span> u<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">pub</span> v<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">,</span></span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">impl</span> <span class=\"token class-name\">Camera</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">new</span><span class=\"token punctuation\">(</span>lookfrom<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Point3</span><span class=\"token punctuation\">,</span> lookat<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Point3</span><span class=\"token punctuation\">,</span> vup<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">,</span> fov<span class=\"token punctuation\">:</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">,</span> aspect_ratio<span class=\"token punctuation\">:</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">,</span> aperture<span class=\"token punctuation\">:</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">,</span> focus_dist<span class=\"token punctuation\">:</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Camera</span> <span class=\"token punctuation\">{</span></span>        <span class=\"token keyword\">let</span> theta <span class=\"token operator\">=</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">::</span><span class=\"token function\">to_radians</span><span class=\"token punctuation\">(</span>fov<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> h <span class=\"token operator\">=</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">::</span><span class=\"token function\">tan</span><span class=\"token punctuation\">(</span>theta <span class=\"token operator\">/</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> viewport_height <span class=\"token operator\">=</span> <span class=\"token number\">2.0</span> <span class=\"token operator\">*</span> h<span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> viewport_width <span class=\"token operator\">=</span> aspect_ratio <span class=\"token operator\">*</span> viewport_height<span class=\"token punctuation\">;</span>\n\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">let</span> w <span class=\"token operator\">=</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">::</span><span class=\"token function\">unit_vector</span><span class=\"token punctuation\">(</span>lookfrom <span class=\"token operator\">-</span> lookat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">let</span> u <span class=\"token operator\">=</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">::</span><span class=\"token function\">unit_vector</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">::</span><span class=\"token function\">cross</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>vup<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">let</span> v <span class=\"token operator\">=</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">::</span><span class=\"token function\">cross</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>w<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>u<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n        <span class=\"token keyword\">let</span> origin <span class=\"token operator\">=</span> lookfrom<span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">let</span> horizontal <span class=\"token operator\">=</span> focus_dist <span class=\"token operator\">*</span> viewport_width <span class=\"token operator\">*</span> u<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">let</span> vertical <span class=\"token operator\">=</span> focus_dist <span class=\"token operator\">*</span> viewport_height <span class=\"token operator\">*</span> v<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">let</span> lower_left_corner <span class=\"token operator\">=</span> origin <span class=\"token operator\">-</span> horizontal <span class=\"token operator\">/</span> <span class=\"token number\">2.0</span> <span class=\"token operator\">-</span> vertical <span class=\"token operator\">/</span> <span class=\"token number\">2.0</span> <span class=\"token operator\">-</span> focus_dist <span class=\"token operator\">*</span> w<span class=\"token punctuation\">;</span></span>\n        <span class=\"token class-name\">Camera</span> <span class=\"token punctuation\">{</span>\n            origin<span class=\"token punctuation\">,</span>\n            horizontal<span class=\"token punctuation\">,</span>\n            vertical<span class=\"token punctuation\">,</span>\n            lower_left_corner<span class=\"token punctuation\">,</span>\n<span class=\"gatsby-highlight-code-line\">            lens_radius<span class=\"token punctuation\">:</span> aperture <span class=\"token operator\">/</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">            u<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">            v<span class=\"token punctuation\">,</span></span>        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">pub</span> <span class=\"token keyword\">fn</span> <span class=\"token function-definition function\">get_ray</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">,</span> s<span class=\"token punctuation\">:</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">,</span> t<span class=\"token punctuation\">:</span> <span class=\"token keyword\">f64</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">-></span> <span class=\"token class-name\">Ray</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">let</span> rd <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>lens_radius <span class=\"token operator\">*</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">::</span><span class=\"token function\">random_in_unit_disk</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">        <span class=\"token keyword\">let</span> offset <span class=\"token operator\">=</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>u <span class=\"token operator\">*</span> rd<span class=\"token punctuation\">.</span><span class=\"token function\">x</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>v <span class=\"token operator\">*</span> rd<span class=\"token punctuation\">.</span><span class=\"token function\">y</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\">        <span class=\"token class-name\">Ray</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>origin <span class=\"token operator\">+</span> offset<span class=\"token punctuation\">,</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>lower_left_corner <span class=\"token operator\">+</span> s <span class=\"token operator\">*</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>horizontal <span class=\"token operator\">+</span> t <span class=\"token operator\">*</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>vertical <span class=\"token operator\">-</span> <span class=\"token keyword\">self</span><span class=\"token punctuation\">.</span>origin <span class=\"token operator\">-</span> offset<span class=\"token punctuation\">)</span></span>    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>Setup a large aperture:</p>\n<div class=\"gatsby-highlight\" data-language=\"rust\"><pre style=\"counter-reset: linenumber 0\" class=\"language-rust line-numbers\"><code class=\"language-rust\">    <span class=\"token keyword\">let</span> lookfrom <span class=\"token operator\">=</span> <span class=\"token class-name\">Point3</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token number\">3.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> lookat <span class=\"token operator\">=</span> <span class=\"token class-name\">Point3</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">1.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">let</span> dist_to_focus <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>lookfrom <span class=\"token operator\">-</span> lookat<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">length</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">let</span> cam <span class=\"token operator\">=</span> <span class=\"token class-name\">Camera</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span>lookfrom<span class=\"token punctuation\">,</span> lookat<span class=\"token punctuation\">,</span> <span class=\"token class-name\">Vec3</span><span class=\"token punctuation\">::</span><span class=\"token function\">new</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0.0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">20.0</span><span class=\"token punctuation\">,</span> aspect_ratio<span class=\"token punctuation\">,</span> <span class=\"token number\">2.0</span><span class=\"token punctuation\">,</span> dist_to_focus<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>This gives:</p>\n<p><figure class=\"gatsby-resp-image-figure\" style=\"\">\n    <span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 400px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/67bb4fbc5f24823c86fbbeab25b57620/d9f49/defocus.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.44444444444444%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsSAAALEgHS3X78AAACLElEQVQoz2XPyW8SYRgG8HfswYP2YGLCrdYmxqUeXRCNEG1cUsWlBqwtbUFSY0yUAKmNS0KNaebQ2lAr2ClLAZl9ZSiMBBkKzFDSkPgnOYMcakyevPkO7+998gGvA68jxhT3hiu/l8rd9+XuW6X7Tu4MF/ehuI8IbWBbCK/B/wETawinQaHjKHQ8bGuM18bLXdePqjOSHF9KOrMVi7Rneq63ZswDWOtjQR8R2xOC7il03GvU/K2XjHW2dmWmdudVfoMbFdvANA+xLeCMmCf+xZw2KOg3Rd1JqvedAczqkR1+zuGnL08VH4eWmfoxTh3i6kNsc7B/ogX9M8aLbSJM4wTfuhgX7tqfJ6/7cDPenHXy+wN/BKfdkuQTxDmxdI9TR4xlExtnzDSA3gVSRfDq4U3++Nj88rXZLbs3ZpuO2l0LHz56GSJAU2GKDEnsa6n4iFUtTNPATeMzQDcMCfkqbJeRhAQvPl299BS1TaMXJhYnfW4i5Zf5MEEGjRTY0A7vY5VRpvEX92qJHk6XIM4DmgRP+PSNqdv2J9bgwhkBdyniG5kPGlGEgMw8o+RTdL2HjVpqt9+cUWBLgnUCUAwWUQhGIPJ5IBE/JxAPZWamyMxJpJvI2fLSUVo90EzVAf8FuQpslyBRgBiDrOdhNYWgX2F1ZQDbsGSws9nE+TR2Mp09gu8AXQPzw2Z5DxM1szz70/TJAmxyECMgmoIvUYiuwLc1iEcBi0OGBFIx8R8UCTxSpwtl7wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Spheres with depth-of-field\"\n        title=\"Spheres with depth-of-field\"\n        src=\"/static/67bb4fbc5f24823c86fbbeab25b57620/d9f49/defocus.png\"\n        srcset=\"/static/67bb4fbc5f24823c86fbbeab25b57620/0608e/defocus.png 225w,\n/static/67bb4fbc5f24823c86fbbeab25b57620/d9f49/defocus.png 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span>\n    <figcaption class=\"gatsby-resp-image-figcaption\">Spheres with depth-of-field</figcaption>\n  </figure></p>\n<p>The complete code is <a href=\"https://github.com/austindoupnik/ray-tracing-in-one-weekend-with-rust/tree/v0.0.1-chapter.12\">available here</a>.</p>","frontmatter":{"title":"Ch 12. Defocus Blur","series":{"title":"Ray Tracing in One Weekend with Rust","part":11},"date":"October 27, 2020","tags":["rust","ray tracing"]},"fields":{"slug":"/post/2020-10/defocus-blur/"}}},"pageContext":{"slug":"/post/2020-10/defocus-blur/","previous":{"fields":{"slug":"/post/2020-10/positionable-camera/"},"frontmatter":{"title":"Ch 11. Positionable Camera"}},"next":{"fields":{"slug":"/post/2020-10/where-next/"},"frontmatter":{"title":"Ch 13. Where Next?"}}}},"staticQueryHashes":["1242404783","1672915144","1933047930","2463615370"]}